<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="google" value="notranslate">
  <title>Macro:Byte</title>
  <link rel="stylesheet" href="style.css">
  <style>
    #overlay {
        background-color: rgba(0, 0, 0, 0.8);
        z-index: 998;
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        display: none;
    }​
    .button_run {
      background: #0000f4;
      color: #ffffff;
    }
    .button_stop {
      background: #f40000;
      color: #ffffff;
    }
	  .scroll-box {
	      background: #f4f4f4;
	      border: 2px solid rgba(0, 0, 0, 0.1);
	      height: auto; /* maximum height of the box, feel free to change this! */
        min-height: 100% !important;
	      padding: 15px;
	      overflow-y: scroll;
	  }
    textarea#log {
    	width:100%;
      height:100px;
    	box-sizing:border-box;
    	display:block;
    	max-width:100%;
      max-height:100px;
    	line-height:8;
    	border-radius:3px;
    	border:1px solid #F7E98D;
    	font:13px Tahoma, cursive;
    	transition:box-shadow 0.5s ease;
    	box-shadow:0 4px 6px rgba(0,0,0,0.1);
    	font-smoothing:subpixel-antialiased;
    	background:linear-gradient(#F9EFAF, #F7E98D);
    	background:-o-linear-gradient(#F9EFAF, #F7E98D);
    	background:-ms-linear-gradient(#F9EFAF, #F7E98D);
    	background:-moz-linear-gradient(#F9EFAF, #F7E98D);
    	background:-webkit-linear-gradient(#F9EFAF, #F7E98D);
    }

    .projectname {
        font-size:24px;
    }
    .watermark {
        opacity: 0.5;
        color: BLACK;
        position: fixed;
        top: auto;
        left: 80%;
        font-size:48px;
    }
    /* Center the loader */
    #loader {
      position: absolute;
      left: 50%;
      top: 50%;
      z-index: 1;
      width: 150px;
      height: 150px;
      margin: -75px 0 0 -75px;
      border: 16px solid #f3f3f3;
      border-radius: 50%;
      border-top: 16px solid #3498db;
      width: 120px;
      height: 120px;
      -webkit-animation: spin 2s linear infinite;
      animation: spin 2s linear infinite;
      z-index: 999;
    }

    @-webkit-keyframes spin {
      0% { -webkit-transform: rotate(0deg); }
      100% { -webkit-transform: rotate(360deg); }
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Add animation to "page content" */
    .animate-bottom {
      position: relative;
      -webkit-animation-name: animatebottom;
      -webkit-animation-duration: 1s;
      animation-name: animatebottom;
      animation-duration: 1s
    }

    @-webkit-keyframes animatebottom {
      from { bottom:-100px; opacity:0 } 
      to { bottom:0px; opacity:1 }
    }

    @keyframes animatebottom { 
      from{ bottom:-100px; opacity:0 } 
      to{ bottom:0; opacity:1 }
    }

	  </style>
<!--
  <script src="https://www.google.com/jsapi"></script>
    -->
    <!--改用本地jquery-->
  <script src="jquery-3.2.1.min.js"></script>
  <script src="storage.js"></script>
  <script src="../../blockly_compressed.js"></script>
  <script src="../../blocks_compressed.js"></script>
  <script src="../../javascript_compressed.js"></script>
  <script src="../../python_compressed.js"></script>
  <script src="../../php_compressed.js"></script>
  <script src="../../lua_compressed.js"></script>
  <script src="../../dart_compressed.js"></script>
  <script src="code.js"></script>
  <script src="FileSaver.js"></script>
  <script src="nipplejs.min.js"></script>
  <script>
    /*
    Blockly.Blocks['websocket_'] = {
      init: function() {
        this.appendDummyInput()
            .appendField("Websocket Server");
        this.appendDummyInput()
            .appendField("message_received")
            .appendField(new Blockly.FieldVariable("client"), "client")
            .appendField(new Blockly.FieldVariable("server"), "server")
            .appendField(new Blockly.FieldVariable("message"), "message");
        this.appendStatementInput("message_received")
            .setCheck(null);
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setColour(330);
     this.setTooltip("");
     this.setHelpUrl("");
      }
    };
  Blockly.Blocks['websocket_server'] = {
  init: function() {
    this.appendDummyInput()
        .appendField("Websocket Server");
    this.setPreviousStatement(true, null);
    this.setNextStatement(true, null);
    this.setColour(330);
    this.setTooltip('websocket server');
    this.setHelpUrl('');
  }
};
    */
		/*
		Blockly.Blocks['message_received'] = {
		  init: function() {
		    this.appendDummyInput()
		        .appendField("message_received")
		        .appendField(new Blockly.FieldVariable("client"), "client")
		        .appendField(new Blockly.FieldVariable("server"), "server")
		        .appendField(new Blockly.FieldVariable("message"), "message");
		    this.appendStatementInput("message_received")
		        .setCheck(null);
		    this.setColour(330);
		    this.setTooltip('message_received');
		    this.setHelpUrl('');
		  }
		};
		Blockly.Blocks['server_send_message_to_all'] = {
		  init: function() {
		    this.appendValueInput("message")
		        .setCheck(null)
		        .appendField("server.send_message_to_all");
		    this.setInputsInline(true);
		    this.setPreviousStatement(true, null);
		    this.setNextStatement(true, null);
		    this.setColour(330);
		    this.setTooltip('server.send_message_to_all');
		    this.setHelpUrl('');
		  }
		};
		*/
Blockly.Blocks['mechabyte_init'] = {
  init: function() {
    this.appendDummyInput()
        .appendField("mechaByte Init");
    this.setPreviousStatement(false, null);
    this.setNextStatement(true, null);
    this.setColour(95);
    this.setTooltip("");
    this.setHelpUrl("");
  }
};
Blockly.Blocks['sleep'] = {
  init: function() {
    this.appendValueInput("seconds")
        .setCheck(null)
        .appendField("sleep");
    this.appendDummyInput()
        .appendField("secs");
    this.setInputsInline(true);
    this.setPreviousStatement(true, null);
    this.setNextStatement(true, null);
    this.setColour(95);
 this.setTooltip("");
 this.setHelpUrl("");
  }
};
Blockly.Blocks['time()'] = {
  init: function() {
    this.appendDummyInput()
        .appendField("time()");
		this.setOutput(true, null);
    this.setColour(95);
 this.setTooltip("");
 this.setHelpUrl("");
  }
};
Blockly.Blocks['thread_init'] = {
  init: function() {        
    this.appendValueInput("thread_funciton")
        .setCheck(null)
				.appendField("Thread Funciton = ");
    this.setPreviousStatement(true, null);
    this.setNextStatement(true, null);
    this.setColour(95);
    this.setTooltip('Thread Init.');
    this.setHelpUrl('');
  }
};
/*
Blockly.Blocks['thread_funciton'] = {
  init: function() {
    this.appendDummyInput()
        .appendField("thread")
		this.appendStatementInput("thread_funciton")
    		.setCheck(null);
    this.setColour(95);
    this.setTooltip('thread_funciton');
    this.setHelpUrl('');
  }
};
*/
/*
Blockly.Blocks['macrobyte_init'] = {
  init: function() {
    this.appendDummyInput()
        .appendField("mecha Byte Init");
    this.setPreviousStatement(false, null);
    this.setNextStatement(true, null);
    this.setColour('#000000');
    this.setTooltip('mecha BYTE Init.');
    this.setHelpUrl('');
  }
};
Blockly.Blocks['start_streaming'] = {
  init: function() {
    this.appendDummyInput()
        .appendField("start video streaming on");
    this.appendValueInput("port")
        .setCheck(null)
        .appendField("port");
    this.setInputsInline(true);
  }
};
*/
Blockly.Blocks['car_init'] = {
  init: function() {
    this.appendDummyInput()
        .appendField("mechaCar init with");
    this.appendDummyInput()
        .appendField("DC2")
        .appendField(new Blockly.FieldDropdown([["A","A"], ["B","B"]]), "port2")
        .appendField("as forward and");
    this.appendDummyInput()
        .appendField("DC4")
        .appendField(new Blockly.FieldDropdown([["A","A"], ["B","B"]]), "port4")
        .appendField("as forward");
    this.setPreviousStatement(true, null);
    this.setNextStatement(true, null);
    this.setColour('#000000');
    this.setTooltip('mechaCar Init.');
    this.setHelpUrl('');
  }
};
Blockly.Blocks['car_forward'] = {
  init: function() {
    this.appendDummyInput()
        .appendField("mechaCar forward");
    this.appendValueInput("speed")
        .setCheck(null)
        .appendField("with speed");
    this.setPreviousStatement(true, null);
    this.setNextStatement(true, null);
    this.setInputsInline(true);
    this.setColour('#000000');
    this.setTooltip('');
    this.setHelpUrl('');
  }
};
Blockly.Blocks['car_backward'] = {
  init: function() {
    this.appendDummyInput()
        .appendField("mechaCar backward");
    this.appendValueInput("speed")
        .setCheck(null)
        .appendField("with speed");
    this.setPreviousStatement(true, null);
    this.setNextStatement(true, null);
    this.setInputsInline(true);
    this.setColour('#000000');
    this.setTooltip('');
    this.setHelpUrl('');
  }
};
Blockly.Blocks['car_spin_left'] = {
  init: function() {
    this.appendDummyInput()
        .appendField("mechaCar turn left");
    this.appendValueInput("speed")
        .setCheck(null)
        .appendField("with speed");
    this.setPreviousStatement(true, null);
    this.setNextStatement(true, null);
    this.setInputsInline(true);
    this.setColour('#000000');
    this.setTooltip('');
    this.setHelpUrl('');
  }
};
Blockly.Blocks['car_spin_right'] = {
  init: function() {
    this.appendDummyInput()
        .appendField("mechaCar turn right");
    this.appendValueInput("speed")
        .setCheck(null)
        .appendField("with speed");
    this.setPreviousStatement(true, null);
    this.setNextStatement(true, null);
    this.setInputsInline(true);
    this.setColour('#000000');
    this.setTooltip('');
    this.setHelpUrl('');
  }
};
Blockly.Blocks['car_stop'] = {
  init: function() {
    this.appendDummyInput()
        .appendField("mechaCar stop");
    this.setPreviousStatement(true, null);
    this.setNextStatement(true, null);
    this.setInputsInline(true);
    this.setColour('#000000');
    this.setTooltip('');
    this.setHelpUrl('');
  }
};
Blockly.Blocks['car_pid'] = {
  init: function() {
    //this.appendDummyInput()
        //.appendField("MechaCar settle");
    this.appendValueInput("measure")
        .setCheck(null)
        .appendField("mechaCar now at")
        .setAlign(Blockly.ALIGN_RIGHT);
    this.appendValueInput("distance")
        .setCheck(null)
        .appendField("and settles at")
        .setAlign(Blockly.ALIGN_RIGHT);
    this.appendDummyInput()
        .appendField("using PID control");
    this.appendValueInput("kp")
        .setCheck(null)
        .appendField("with Kp")
        .setAlign(Blockly.ALIGN_RIGHT);
    this.appendValueInput("ki")
        .setCheck(null)
        .appendField("Ki")
        .setAlign(Blockly.ALIGN_RIGHT);;
    this.appendValueInput("kd")
        .setCheck(null)
        .appendField("Kd")
        .setAlign(Blockly.ALIGN_RIGHT);;
    this.setPreviousStatement(true, null);
    this.setNextStatement(true, null);
    this.setInputsInline(false);
    this.setColour('#000000');
    this.setTooltip('');
    this.setHelpUrl('');
  }
};
Blockly.Blocks['set_pin_mode_cb'] = {
  init: function() {
    this.appendDummyInput()
        .appendField("make pin");
    this.appendValueInput("pin")
        .setCheck(null);
        this.appendDummyInput()
            .appendField("as a");
    this.appendDummyInput()
        .appendField(new Blockly.FieldDropdown([["ANALOG","ANALOG"], ["DIGITAL","DIGITAL"]]), "type")
        .appendField(new Blockly.FieldDropdown([["INPUT","INPUT"], ["OUTPUT","OUTPUT"], ["PWM","PWM"]]), "mode");
    this.appendValueInput("cb_func")
        .setCheck(null)
				.appendField("Callback Funciton = ");
    this.setInputsInline(true);
    this.setPreviousStatement(true, null);
    this.setNextStatement(true, null);
    this.setColour(75);
    this.setTooltip('');
    this.setHelpUrl('');
  }
};
Blockly.Blocks['set_pin_mode'] = {
  init: function() {
    this.appendDummyInput()
        .appendField("make pin");
    this.appendValueInput("pin")
        .setCheck(null);
        this.appendDummyInput()
            .appendField("as a");
    this.appendDummyInput()
        .appendField(new Blockly.FieldDropdown([["ANALOG","ANALOG"], ["DIGITAL","DIGITAL"]]), "type")
        .appendField(new Blockly.FieldDropdown([["INPUT","INPUT"], ["OUTPUT","OUTPUT"], ["PWM","PWM"]]), "mode");
    this.setInputsInline(true);
    this.setPreviousStatement(true, null);
    this.setNextStatement(true, null);
    this.setColour(75);
    this.setTooltip('');
    this.setHelpUrl('');
  }
};
Blockly.Blocks['write_pin'] = {
  init: function() {
    this.appendDummyInput()
        .appendField(new Blockly.FieldDropdown([["digital","digital"], ["analog","analog"]]), "type");
    this.appendValueInput("pin")
        .setCheck(null)
        .appendField("write to pin");
    this.appendValueInput("value")
        .setCheck(null)
        .appendField("with value");
    this.setInputsInline(true);
    this.setPreviousStatement(true, null);
    this.setNextStatement(true, null);
    this.setColour(75);
    this.setTooltip('');
    this.setHelpUrl('');
  }
};
Blockly.Blocks['read_pin'] = {
  init: function() {
    this.appendDummyInput()
        .appendField(new Blockly.FieldDropdown([["digital","digital"], ["analog","analog"]]), "type");
    this.appendValueInput("pin")
        .setCheck(null)
        .appendField("read on pin");
    this.setInputsInline(true);
    this.setOutput(true, null);
    this.setColour(75);
    this.setTooltip('');
    this.setHelpUrl('');
  }
};
Blockly.Blocks['play_tone'] = {
  init: function() {
    this.appendDummyInput()
        .appendField("play tone at pin");
    this.appendValueInput("pin")
        .setCheck(null);
    this.appendDummyInput()
        .appendField(new Blockly.FieldDropdown([["TONE_TONE","TONE_TONE"], ["TONE_NO_TONE","TONE_NO_TONE"]]), "cmd");
    this.appendValueInput("frequency")
        .setCheck(null)
        .appendField("frequency");
    this.appendValueInput("duration")
        .setCheck(null)
        .appendField("duration");
    this.setInputsInline(true);
    this.setPreviousStatement(true, null);
    this.setNextStatement(true, null);
    this.setColour(60);
    this.setTooltip('');
    this.setHelpUrl('');
  }
};
Blockly.Blocks['servo_setup'] = {
  init: function() {
    this.appendDummyInput()
        .appendField("using servo")
        .appendField(new Blockly.FieldDropdown([["1","14"], ["2","15"], ["3","16"], ["4","17"], ["5","4"], ["6","7"]]), "pin");
    this.setPreviousStatement(true, null);
    this.setNextStatement(true, null);
    this.setColour('#000000');
 this.setTooltip("");
 this.setHelpUrl("");
  }
};
Blockly.Blocks['servo_rotate'] = {
  init: function() {
    this.appendDummyInput()
        .appendField("move servo")
        .appendField(new Blockly.FieldDropdown([["1","14"], ["2","15"], ["3","16"], ["4","17"], ["5","4"], ["6","7"]]), "pin");
    this.appendValueInput("value")
        .setCheck(null)
        .appendField("to");
    this.appendDummyInput()
        .appendField("degrees");
    this.setInputsInline(true);
    this.setPreviousStatement(true, null);
    this.setNextStatement(true, null);
    this.setColour('#000000');
 this.setTooltip("");
 this.setHelpUrl("");
  }
};
Blockly.Blocks['servo_config'] = {
  init: function() {
    this.appendDummyInput()
        .appendField("servo config");
    this.appendValueInput("pin")
        .setCheck(null)
        .appendField("pin");
    this.setInputsInline(true);
    this.setPreviousStatement(true, null);
    this.setNextStatement(true, null);
    this.setColour(35);
    this.setTooltip('');
    this.setHelpUrl('');
  }
};
Blockly.Blocks['servo_set'] = {
  init: function() {
    this.appendDummyInput()
        .appendField("servo set");
    this.appendValueInput("pin")
        .setCheck(null)
        .appendField("pin");
    this.appendValueInput("value")
        .setCheck(null)
        .appendField("value");
    this.setInputsInline(true);
    this.setPreviousStatement(true, null);
    this.setNextStatement(true, null);
    this.setColour(35);
    this.setTooltip('');
    this.setHelpUrl('');
  }
};
Blockly.Blocks['dc_setup'] = {
  init: function() {
    this.appendDummyInput()
        .appendField("using DC")
        .appendField(new Blockly.FieldDropdown([["1","13"], ["2","11"], ["3","9"], ["4","6"]]), "channel");
    this.setPreviousStatement(true, null);
    this.setNextStatement(true, null);
    this.setColour('#000000');
 this.setTooltip("");
 this.setHelpUrl("");
  }
};
Blockly.Blocks['dc_spin'] = {
  init: function() {
    this.appendDummyInput()
        .appendField("make DC")
        .appendField(new Blockly.FieldDropdown([["1","13"], ["2","11"], ["3","9"], ["4","6"]]), "channel");
    this.appendDummyInput()
        .appendField("run with");
    this.appendDummyInput()
        .appendField(new Blockly.FieldDropdown([["A","A"], ["B","B"]]), "polarity");
    this.appendValueInput("value")
        .setCheck(null)
        .appendField("");
    this.setInputsInline(true);
    this.setPreviousStatement(true, null);
    this.setNextStatement(true, null);
    this.setColour('#000000');
    this.setTooltip('');
    this.setHelpUrl('');
  }
};
Blockly.Blocks['i2c_init'] = {
  init: function() {
    this.appendDummyInput()
        .appendField("i2c Init. 2(SDA) 3(SCL)");
    this.setPreviousStatement(true, null);
    this.setNextStatement(true, null);
    this.setColour(315);
 this.setTooltip("");
 this.setHelpUrl("");
  }
};
Blockly.Blocks['i2c_write'] = {
  init: function() {
    this.appendDummyInput()
        .appendField("i2c write");
    this.appendValueInput("addr")
        .setCheck(null)
        .appendField("addr");
//    this.appendValueInput("data")
//        .setCheck(null)
//        .appendField("data");
        
    this.appendDummyInput()
        .appendField("data(s)");
    this.itemCount_ = 2;
    this.updateShape_();
    this.setMutator(new Blockly.Mutator(['parameters_create_with_item']));

    this.setInputsInline(true);
    this.setPreviousStatement(true, null);
    this.setNextStatement(true, null);
    this.setColour(315);
 this.setTooltip("");
 this.setHelpUrl(""); 
  },
  
  /**
   * Create XML to represent list inputs.
   * @return {!Element} XML storage element.
   * @this Blockly.Block
   */
  mutationToDom: function() {
    var container = document.createElement('mutation');
    container.setAttribute('items', this.itemCount_);
    return container;
  },
  /**
   * Parse XML to restore the list inputs.
   * @param {!Element} xmlElement XML storage element.
   * @this Blockly.Block
   */
  domToMutation: function(xmlElement) {
    this.itemCount_ = parseInt(xmlElement.getAttribute('items'), 10);
    this.updateShape_();
  },
  /**
   * Populate the mutator's dialog with this block's components.
   * @param {!Blockly.Workspace} workspace Mutator's workspace.
   * @return {!Blockly.Block} Root block in mutator.
   * @this Blockly.Block
   */
  decompose: function(workspace) {
    var containerBlock = workspace.newBlock('parameters_create_with_container');
    containerBlock.initSvg();
    var connection = containerBlock.getInput('STACK').connection;
    for (var i = 0; i < this.itemCount_; i++) {
      var itemBlock = workspace.newBlock('parameters_create_with_item');
      itemBlock.initSvg();
      connection.connect(itemBlock.previousConnection);
      connection = itemBlock.nextConnection;
    }
    return containerBlock;
  },
  /**
   * Reconfigure this block based on the mutator dialog's components.
   * @param {!Blockly.Block} containerBlock Root block in mutator.
   * @this Blockly.Block
   */
  compose: function(containerBlock) {
    var itemBlock = containerBlock.getInputTargetBlock('STACK');
    // Count number of inputs.
    var connections = [];
    while (itemBlock) {
      connections.push(itemBlock.valueConnection_);
      itemBlock = itemBlock.nextConnection &&
          itemBlock.nextConnection.targetBlock();
    }
    // Disconnect any children that don't belong.
    for (var i = 0; i < this.itemCount_; i++) {
      var connection = this.getInput('ADD' + i).connection.targetConnection;
      if (connection && connections.indexOf(connection) == -1) {
        connection.disconnect();
      }
    }
    this.itemCount_ = connections.length;
    this.updateShape_();
    // Reconnect any child blocks.
    for (var i = 0; i < this.itemCount_; i++) {
      Blockly.Mutator.reconnect(connections[i], this, 'ADD' + i);
    }
  },
  /**
   * Store pointers to any connected child blocks.
   * @param {!Blockly.Block} containerBlock Root block in mutator.
   * @this Blockly.Block
   */
  saveConnections: function(containerBlock) {
    var itemBlock = containerBlock.getInputTargetBlock('STACK');
    var i = 0;
    while (itemBlock) {
      var input = this.getInput('ADD' + i);
      itemBlock.valueConnection_ = input && input.connection.targetConnection;
      i++;
      itemBlock = itemBlock.nextConnection &&
          itemBlock.nextConnection.targetBlock();
    }
  },
  /**
   * Modify this block to have the correct number of inputs.
   * @private
   * @this Blockly.Block
   */
  updateShape_: function() {
    if (this.itemCount_ && this.getInput('EMPTY')) {
      this.removeInput('EMPTY');
    } else if (!this.itemCount_ && !this.getInput('EMPTY')) {
      this.appendDummyInput('EMPTY')
          .appendField(Blockly.Msg.LISTS_CREATE_EMPTY_TITLE);
    }
    // Add new inputs.
    for (var i = 0; i < this.itemCount_; i++) {
      if (!this.getInput('ADD' + i)) {
        var input = this.appendValueInput('ADD' + i);
        if (i == 0) {
          //input.appendField(MSG["PARAMETERS_CREATE_WITH_INPUT_WITH"]);
        }
      }
    }
    // Remove deleted inputs.
    while (this.getInput('ADD' + i)) {
      this.removeInput('ADD' + i);
      i++;
    }
  }
};


Blockly.Blocks['parameters_create_with'] = {
  /**
   * Block for creating a parameter list with any number of elements of any type.
   * @this Blockly.Block
   */
  init: function() {
    this.setHelpUrl(Blockly.Msg.LISTS_CREATE_WITH_HELPURL);
    this.setColour(Blockly.Blocks.lists.HUE);
    this.itemCount_ = 2;
    this.updateShape_();
    this.setOutput(true, 'Array');
    this.setMutator(new Blockly.Mutator(['parameters_create_with_item']));
    this.setTooltip(Blockly.Msg.LISTS_CREATE_WITH_TOOLTIP);
  },
  /**
   * Create XML to represent list inputs.
   * @return {!Element} XML storage element.
   * @this Blockly.Block
   */
  mutationToDom: function() {
    var container = document.createElement('mutation');
    container.setAttribute('items', this.itemCount_);
    return container;
  },
  /**
   * Parse XML to restore the list inputs.
   * @param {!Element} xmlElement XML storage element.
   * @this Blockly.Block
   */
  domToMutation: function(xmlElement) {
    this.itemCount_ = parseInt(xmlElement.getAttribute('items'), 10);
    this.updateShape_();
  },
  /**
   * Populate the mutator's dialog with this block's components.
   * @param {!Blockly.Workspace} workspace Mutator's workspace.
   * @return {!Blockly.Block} Root block in mutator.
   * @this Blockly.Block
   */
  decompose: function(workspace) {
    var containerBlock = workspace.newBlock('parameters_create_with_container');
    containerBlock.initSvg();
    var connection = containerBlock.getInput('STACK').connection;
    for (var i = 0; i < this.itemCount_; i++) {
      var itemBlock = workspace.newBlock('parameters_create_with_item');
      itemBlock.initSvg();
      connection.connect(itemBlock.previousConnection);
      connection = itemBlock.nextConnection;
    }
    return containerBlock;
  },
  /**
   * Reconfigure this block based on the mutator dialog's components.
   * @param {!Blockly.Block} containerBlock Root block in mutator.
   * @this Blockly.Block
   */
  compose: function(containerBlock) {
    var itemBlock = containerBlock.getInputTargetBlock('STACK');
    // Count number of inputs.
    var connections = [];
    while (itemBlock) {
      connections.push(itemBlock.valueConnection_);
      itemBlock = itemBlock.nextConnection &&
          itemBlock.nextConnection.targetBlock();
    }
    // Disconnect any children that don't belong.
    for (var i = 0; i < this.itemCount_; i++) {
      var connection = this.getInput('ADD' + i).connection.targetConnection;
      if (connection && connections.indexOf(connection) == -1) {
        connection.disconnect();
      }
    }
    this.itemCount_ = connections.length;
    this.updateShape_();
    // Reconnect any child blocks.
    for (var i = 0; i < this.itemCount_; i++) {
      Blockly.Mutator.reconnect(connections[i], this, 'ADD' + i);
    }
  },
  /**
   * Store pointers to any connected child blocks.
   * @param {!Blockly.Block} containerBlock Root block in mutator.
   * @this Blockly.Block
   */
  saveConnections: function(containerBlock) {
    var itemBlock = containerBlock.getInputTargetBlock('STACK');
    var i = 0;
    while (itemBlock) {
      var input = this.getInput('ADD' + i);
      itemBlock.valueConnection_ = input && input.connection.targetConnection;
      i++;
      itemBlock = itemBlock.nextConnection &&
          itemBlock.nextConnection.targetBlock();
    }
  },
  /**
   * Modify this block to have the correct number of inputs.
   * @private
   * @this Blockly.Block
   */
  updateShape_: function() {
    if (this.itemCount_ && this.getInput('EMPTY')) {
      this.removeInput('EMPTY');
    } else if (!this.itemCount_ && !this.getInput('EMPTY')) {
      this.appendDummyInput('EMPTY')
          .appendField(Blockly.Msg.LISTS_CREATE_EMPTY_TITLE);
    }
    // Add new inputs.
    for (var i = 0; i < this.itemCount_; i++) {
      if (!this.getInput('ADD' + i)) {
        var input = this.appendValueInput('ADD' + i);
        if (i == 0) {
          input.appendField(MSG["PARAMETERS_CREATE_WITH_INPUT_WITH"]);
        }
      }
    }
    // Remove deleted inputs.
    while (this.getInput('ADD' + i)) {
      this.removeInput('ADD' + i);
      i++;
    }
  }
};
Blockly.Blocks['parameters_create_with_container'] = {
  /**
   * Mutator block for parameter container.
   * @this Blockly.Block
   */
  init: function() {
    this.setColour(Blockly.Blocks.lists.HUE);
    this.appendDummyInput()
        .appendField(MSG["PARAMETERS_CREATE_WITH_CONTAINER_TITLE_ADD"]);
    this.appendStatementInput('STACK');
    this.setTooltip(Blockly.Msg.LISTS_CREATE_WITH_CONTAINER_TOOLTIP);
    this.contextMenu = false;
  }
};
Blockly.Blocks['parameters_create_with_item'] = {
  /**
   * Mutator block for adding items.
   * @this Blockly.Block
   */
  init: function() {
    this.setColour(Blockly.Blocks.lists.HUE);
    this.appendDummyInput()
        .appendField(Blockly.Msg.LISTS_CREATE_WITH_ITEM_TITLE);
    this.setPreviousStatement(true);
    this.setNextStatement(true);
    this.setTooltip(Blockly.Msg.LISTS_CREATE_WITH_ITEM_TOOLTIP);
    this.contextMenu = false;
  }
};

Blockly.Blocks['i2c_read'] = {
  init: function() {
    this.appendDummyInput()
        .appendField("i2c read");
    this.appendValueInput("addr")
        .setCheck(null)
        .appendField("addr");
    this.appendValueInput("reg")
        .setCheck(null)
        .appendField("reg");
    this.appendValueInput("num")
        .setCheck(null)
        .appendField("num");
    this.setInputsInline(true);
    this.setPreviousStatement(true, null);
    this.setNextStatement(true, null);
    this.setColour(315);
 this.setTooltip("");
 this.setHelpUrl("");
  }
};
Blockly.Blocks['i2c_get_read_data'] = {
  init: function() {
    this.appendDummyInput()
        .appendField("i2c get read");
    this.appendValueInput("addr")
        .setCheck(null)
        .appendField("addr");
    this.setInputsInline(true);
    this.setOutput(true, null);
    this.setColour(315);
 this.setTooltip("");
 this.setHelpUrl("");
  }
};
Blockly.Blocks['gyro_init'] = {
  init: function() {
    this.appendDummyInput()
        .appendField("Gyro Init. 2(SDA) 3(SCL)");
    this.setPreviousStatement(true, null);
    this.setNextStatement(true, null);
    this.setColour('#711c16');
 this.setTooltip("");
 this.setHelpUrl("");
  }
};
Blockly.Blocks['gyro_read'] = {
  init: function() {
    this.appendDummyInput()
        .appendField("Gyro Read");
    this.setPreviousStatement(true, null);
    this.setNextStatement(true, null);
    this.setColour('#711c16');
 this.setTooltip("");
 this.setHelpUrl("");
  }
};
Blockly.Blocks['gyro_get_read_data'] = {
  init: function() {
    this.appendDummyInput()
        .appendField("Gyro Get Read");
    this.setOutput(true, null);
    this.setColour('#711c16');
 this.setTooltip("");
 this.setHelpUrl("");
  }
};
Blockly.Blocks['convert_list_to_float'] = {
  init: function() {
    this.appendDummyInput()
        .appendField("covert to float from");
    this.appendValueInput("input_list")
        .setCheck(null)
        .appendField("input_list");
    this.setOutput(true, null);
    this.setColour('#711c16');
 this.setTooltip("");
 this.setHelpUrl("");
  }
};
Blockly.Blocks['sonar_config'] = {
  init: function() {
    this.appendValueInput("trigger")
        .setCheck(null)
        .appendField("sonar config trigger");
    this.appendValueInput("echo")
        .setCheck(null)
        .appendField("echo");
    this.setInputsInline(true);
    this.setPreviousStatement(true, null);
    this.setNextStatement(true, null);
    this.setColour(270);
 this.setTooltip("");
 this.setHelpUrl("");
  }
};
Blockly.Blocks['get_sonar_data'] = {
  init: function() {
    this.appendValueInput("trigger")
        .setCheck(null)
        .appendField("get sonar data from trigger");
    this.setInputsInline(true);
    this.setOutput(true, null);
    this.setColour(270);
 this.setTooltip("");
 this.setHelpUrl("");
  }
};
Blockly.Blocks['raw_text'] = {
  init: function() {
    this.appendDummyInput()
				.appendField(new Blockly.FieldTextInput(""), "TEXT");
    this.setInputsInline(true);
    this.setOutput(true, null);
    this.setColour(120);
 this.setTooltip("");
 this.setHelpUrl("");
  }
};

/*
Blockly.Blocks['display_clear'] = {
  init: function() {
    this.appendDummyInput()
        .appendField("display clear");
    this.setPreviousStatement(true, null);
    this.setNextStatement(true, null);
    this.setColour(260);
    this.setTooltip('');
    this.setHelpUrl('');
  }
};
Blockly.Blocks['plot'] = {
  init: function() {
    this.appendDummyInput()
        .appendField("plot(");
    this.appendValueInput("x")
        .setCheck(null)
        .appendField("x :");
    this.appendDummyInput()
        .appendField(",");
    this.appendValueInput("y")
        .setCheck(null)
        .appendField("y :");
    this.appendDummyInput()
        .appendField(",");
    this.appendValueInput("c")
        .setCheck(null)
        .appendField("1/0 :");
    this.appendDummyInput()
        .appendField(")");
    this.setInputsInline(true);
    this.setPreviousStatement(true, null);
    this.setNextStatement(true, null);
    this.setColour(260);
    this.setTooltip('plot');
    this.setHelpUrl('');
  }
};
	  Blockly.Blocks['gpio'] = {
	    init: function() {
	      this.appendValueInput("port")
	          .setCheck("Number")
	          .appendField("gpio port number");
	      this.appendValueInput("value")
	          .setCheck("Number")
	          .appendField("value");
	      this.setInputsInline(true);
	      this.setPreviousStatement(true, null);
	      this.setNextStatement(true, null);
	      this.setColour(60);
	      this.setTooltip('gpio');
	      this.setHelpUrl('');
	    }
	  };
Blockly.Blocks['mt7688_pinmax'] = {
  init: function() {
    this.appendDummyInput()
        .appendField("mt7688_pinmax");
    this.appendDummyInput()
        .appendField("i2c")
        .appendField(new Blockly.FieldDropdown([["i2c","i2c"], ["gpio","gpio"]]), "i2c");
    this.appendDummyInput()
        .appendField("uart0")
        .appendField(new Blockly.FieldDropdown([["uart","uart"], ["gpio","gpio"]]), "uart0");
    this.appendDummyInput()
        .appendField("uart1")
        .appendField(new Blockly.FieldDropdown([["uart","uart"], ["gpio","gpio"]]), "uart1");
    this.appendDummyInput()
        .appendField("uart2")
        .appendField(new Blockly.FieldDropdown([["uart","uart"], ["gpio","gpio"], ["pwm","pwm"]]), "uart2");
    this.appendDummyInput()
        .appendField("pwm0")
        .appendField(new Blockly.FieldDropdown([["pwm","pwm"], ["gpio","gpio"]]), "pwm0");
    this.appendDummyInput()
        .appendField("pwm1")
        .appendField(new Blockly.FieldDropdown([["pwm","pwm"], ["gpio","gpio"]]), "pwm1");
    this.appendDummyInput()
        .appendField("refclk")
        .appendField(new Blockly.FieldDropdown([["gpio","gpio"], ["refclk","refclk"]]), "refclk");
    this.appendDummyInput()
        .appendField("spi_s")
        .appendField(new Blockly.FieldDropdown([["gpio","gpio"], ["spi_s","spi_s"]]), "spi_s");
    this.appendDummyInput()
        .appendField("spi_cs1")
        .appendField(new Blockly.FieldDropdown([["spi_cs1","spi_cs1"], ["gpio","gpio"], ["ref_clk","ref_clk"]]), "spi_cs1");
    this.appendDummyInput()
        .appendField("i2s")
        .appendField(new Blockly.FieldDropdown([["gpio","gpio"], ["i2s","i2s"], ["pcm","pcm"]]), "i2s");
    this.appendDummyInput()
        .appendField("ephy(43)")
        .appendField(new Blockly.FieldDropdown([["ephy","ephy"], ["gpio","gpio"]]), "ephy");
    this.appendDummyInput()
        .appendField("wled(44)")
        .appendField(new Blockly.FieldDropdown([["wled","wled"], ["gpio","gpio"]]), "wled");
    this.setPreviousStatement(true, null);
    this.setNextStatement(true, null);
    this.setColour(60);
    this.setTooltip('mt7688_pinmax');
    this.setHelpUrl('');
  }
};
*/
  </script>
</head>
<body>

<div id="loader"></div>
<div id="overlay"></div>
<table >
	<tr >
  	  <table width="100%" height="70%">
    	<tr >
			<td >
        <!--
        <div class="watermark">
                   Beta
            </div>
          -->
		<!--
      	<td style="background-image:url(logo.png);background-repeat:no-repeat;background-size:250px 42px;" width="250" height="42">
			<h1></h1>
		-->
				  <h1 style="text-shadow: 2px 2px #ffffff;display: flex">mechaBYTE&nbsp;<small><div id="version_string"></div></small>&nbsp;Project Name:<input type="text" id="projectname">
			  </h1>
      		</td>
      <td class="farSide">
        <select id="languageMenu"></select>
      </td>
    </tr>
        <tr>
          <td colspan=2>
            <table width="100%">
              <tr id="tabRow" height="1em">
            <td id="tab_blocks" class="tabon">...</td>
            <td class="tabmin">&nbsp;</td>
            <td id="tab_python" class="taboff">Python</td>
            <td class="tabmin">&nbsp;</td>
			<!--
            <td id="tab_javascript" class="taboff">JavaScript</td>
            <td class="tabmin">&nbsp;</td>
            <td id="tab_php" class="taboff">PHP</td>
            <td class="tabmin">&nbsp;</td>
            <td id="tab_lua" class="taboff">Lua</td>
            <td class="tabmin">&nbsp;</td>
            <td id="tab_dart" class="taboff">Dart</td>
            <td class="tabmin">&nbsp;</td>
			-->
            <td id="tab_xml" class="taboff">XML</td>
            <td class="tabmax">
              <button id="folderButton" class="notext" title="...">
                <img src='../../media/1x1.gif' class="folder icon21">
              </button>
              <button id="uploadScriptButton" class="notext secondary" title="...">
                <img src='../../media/1x1.gif' class="run icon21">
              </button>
              <button id="trashButton" class="notext" title="...">
                <img src='../../media/1x1.gif' class="trash icon21">
              </button>
              <button id="saveButton" class="notext" title="...">
                <img src='../../media/1x1.gif' class="save icon21">
              </button>
              <!--
              <button id="runButton" class="notext primary" title="...">
                <img src='../../media/1x1.gif' class="run icon21">
              </button>
                -->
            </td>
          </tr>
            </table>
          </td>
        </tr>
        <tr>
          <td height="99%" colspan=2 id="content_area">
          </td>
        </tr>
      </table>
  </tr>
  <tr>
    
	    <table width="100%">
		<tr>
		<td>
			<!--
		  <br>
		  <button onclick="init(); return false;">init</button>
		  <button onclick="onCloseClick(); return false;">close</button>
			-->
	  </td>
	  </tr>
    
	  <tr>
		<td>
	  <div id="zone_joystick">
        <textarea id="log"></textarea>
    </div>
	  </td>
    </tr>
	  <tr>
		<td >
      <button onclick="onSubmit(); return false;">Send</button>
<!--		  <form onsubmit="onSubmit(); return false;"> -->
			  <input type="text" id="input">
<!--			  <input type="submit" value="Send">  -->
<!--		  </form>  -->
        <button id="start_stream">Start Stream</button>
        <button onclick="return !window.open('http://'+window.location.hostname+':8080', 'WebCam', 'width=500,height=500')">Open WebCam Window</button>        
<!--        port:<input type="text" id="webcam_port" value="8080" disabled> -->
        <button id="stop_stream">Stop Stream</button>
        <button id="run_program" class="button_run secondary">RUN</button>
        <button id="stop_program" class="button_stop">STOP</button>
        
        <br>
        Board Version:<input type="text" id="boardVersion" disabled>Current Version:<input type="text" id="currentVersion" disabled>
        <button id="check_version">Check Version</button>
        <button id="software_update">Update</button>
          
	  </td>
	  </tr>
	</table>
  
  </tr>
</table>
  <!--<div id="blocklyDiv" style="height: 400px"></div>-->
  <div id="content_blocks" class="content"></div>
  <pre id="content_javascript" class="content"></pre>
  <pre id="content_python" class="content"></pre>
  <pre id="content_php" class="content"></pre>
  <pre id="content_lua" class="content"></pre>
  <pre id="content_dart" class="content"></pre>
  <textarea id="content_xml" class="content" wrap="off"></textarea>

  <xml id="toolbox" style="display: none">
<!--
  <category name="MacroByte" colour="#a5a55b">
    <block type="websocket_server"></block>
	  <block type="message_received">
      <field name="client">client</field>
      <field name="server">server</field>
      <field name="message">message</field>
    </block>
    <block type="display_clear"></block>
    <block type="plot"></block>
  </category>
  -->
  <category name="System" colour="#7BA65C">
    <block type="mechabyte_init"></block>
    <block type="sleep">
      <value name="seconds">
        <shadow  type="math_number">
          <field name="NUM">1</field>
        </shadow>
      </value>
    </block>
    <block type="time()"></block>
		<block type="thread_init"></block>
  </category>
  <category name="mechaCar" colour="#000000">
    <block type="car_init" colour="#000000"></block>
    <block type="servo_setup"></block>
    <block type="servo_rotate">
      <value name="value">
        <shadow  type="math_number">
          <field name="NUM">180</field>
        </shadow>
      </value>
    </block>
    <block type="dc_setup">
      <value name="channel">
        <shadow type="math_number">
          <field name="NUM">1</field>
        </shadow>
      </value>
    </block>
    <block type="dc_spin" colour="#000000">
      <value name="channel">
        <shadow type="math_number">
          <field name="NUM">1</field>
        </shadow>
      </value>
      <value name="port">
        <shadow type="text">
          <field name="TEXT">A</field>
        </shadow>
      </value>
      <value name="value">
        <shadow type="math_number">
          <field name="NUM">255</field>
        </shadow>
      </value>
    </block>
    <block type="car_forward" colour='#000000'>
      <value name="speed">
        <shadow type="math_number">
          <field name="NUM">255</field>
        </shadow>
      </value>
    </block>
    <block type="car_backward" colour='#000000'>
      <value name="speed">
        <shadow type="math_number">
          <field name="NUM">255</field>
        </shadow>
      </value>
    </block>
    <block type="car_spin_left" colour='#000000'>
      <value name="speed">
        <shadow type="math_number">
          <field name="NUM">255</field>
        </shadow>
      </value>
    </block>
    <block type="car_spin_right" colour='#000000'>
      <value name="speed">
        <shadow type="math_number">
          <field name="NUM">255</field>
        </shadow>
      </value>
    </block>
    <block type="car_stop" colour="#000000"></block>
    <!--
    <block type="car_pid" colour='#000000'>
      <value name="kp">
        <shadow type="math_number">
          <field name="NUM">1</field>
        </shadow>
      </value>
      <value name="ki">
        <shadow type="math_number">
          <field name="NUM">0</field>
        </shadow>
      </value>
      <value name="kd">
        <shadow type="math_number">
          <field name="NUM">0</field>
        </shadow>
      </value>
    </block>
    -->
  </category>
  <category name="GPIO" colour="#94a65c">
    <block type="set_pin_mode_cb">
      <value name="pin">
        <shadow  type="math_number">
          <field name="NUM">13</field>
        </shadow>
      </value>
      <field name="mode">OUTPUT</field>
      <field name="type">DIGITAL</field>
    </block>
    <block type="set_pin_mode">
      <value name="pin">
        <shadow  type="math_number">
          <field name="NUM">13</field>
        </shadow>
      </value>
      <field name="mode">OUTPUT</field>
      <field name="type">DIGITAL</field>
    </block>
    <block type="write_pin">
      <value name="pin">
        <shadow  type="math_number">
          <field name="NUM">13</field>
        </shadow>
      </value>
      <value name="value">
        <shadow  type="math_number">
          <field name="NUM">0</field>
        </shadow>
      </value>
      <field name="type">digital</field>
    </block>
    <block type="read_pin">
      <value name="pin">
        <shadow  type="math_number">
          <field name="NUM">13</field>
        </shadow>
      </value>
      <field name="type">digital</field>
    </block>
  </category>
  <category name="Servo" colour="#a6875c">
    <block type="servo_config">
      <value name="pin">
        <shadow  type="math_number">
          <field name="NUM">5</field>
        </shadow>
      </value>
    </block>
    <block type="servo_set">
      <value name="pin">
        <shadow  type="math_number">
          <field name="NUM">5</field>
        </shadow>
      </value>
      <value name="value">
        <shadow  type="math_number">
          <field name="NUM">180</field>
        </shadow>
      </value>
    </block>
  </category>
  <category name="Tone" colour="#a5a55b">
    <block type="play_tone">
      <field name="cmd">TONE_TONE</field>
      <value name="pin">
        <shadow  type="math_number">
          <field name="NUM">9</field>
        </shadow>
      </value>
      <value name="frequency">
        <shadow  type="math_number">
          <field name="NUM">455</field>
        </shadow>
      </value>
      <value name="duration">
        <shadow  type="math_number">
          <field name="NUM">800</field>
        </shadow>
      </value>
    </block>
  </category>
  <category name="i2c" colour="#a65c94">
    <block type="i2c_init"></block>
    <block type="i2c_write">
      <value name="addr">
        <shadow  type="math_number">
          <field name="NUM">0x00</field>
        </shadow>
      </value>
      <value name="data">
          
      </value>
    </block>
    <block type="i2c_read">
      <value name="addr">
        <shadow  type="math_number">
          <field name="NUM">0</field>
        </shadow>
      </value>
      <value name="reg">
        <shadow  type="math_number">
          <field name="NUM">0</field>
        </shadow>
      </value>
      <value name="num">
        <shadow  type="math_number">
          <field name="NUM">0</field>
        </shadow>
      </value>
    </block>
    <block type="i2c_get_read_data">
      <value name="addr">
        <shadow  type="math_number">
          <field name="NUM">0</field>
        </shadow>
      </value>
    </block>
  </category>
  <category name="Gyro" colour="#711c16">
    <block type="gyro_init"></block>
    <block type="gyro_read"></block>
    <block type="gyro_get_read_data"></block>
    <block type="convert_list_to_float"></block>    
  </category>
  <category name="Sonar" colour="#815ca6">
    <block type="sonar_config">
      <value name="trigger">
        <shadow  type="math_number">
          <field name="NUM">8</field>
        </shadow>
      </value>
      <value name="echo">
        <shadow  type="math_number">
          <field name="NUM">7</field>
        </shadow>
      </value>
    </block>
    <block type="get_sonar_data">
      <value name="trigger">
        <shadow  type="math_number">
          <field name="NUM">8</field>
        </shadow>
      </value>
    </block>
  </category>
  <sep></sep>
    <category name="%{BKY_CATLOGIC}" colour="%{BKY_LOGIC_HUE}">
      <block type="controls_if"></block>
      <block type="logic_compare"></block>
      <block type="logic_operation"></block>
      <block type="logic_negate"></block>
      <block type="logic_boolean"></block>
      <block type="logic_null"></block>
      <block type="logic_ternary"></block>
    </category>
    <category name="%{BKY_CATLOOPS}" colour="%{BKY_LOOPS_HUE}">
      <block type="controls_repeat_ext">
        <value name="TIMES">
          <shadow type="math_number">
            <field name="NUM">10</field>
          </shadow>
        </value>
      </block>
      <block type="controls_whileUntil">
        <value name="BOOL">
          <shadow type="logic_boolean">
            <field name="BOOL">TRUE</field>
          </shadow>
        </value>
      </block>
      <block type="controls_for">
        <value name="FROM">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
        <value name="TO">
          <shadow type="math_number">
            <field name="NUM">10</field>
          </shadow>
        </value>
        <value name="BY">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
      </block>
      <block type="controls_forEach"></block>
      <block type="controls_flow_statements"></block>
    </category>
    <category name="%{BKY_CATMATH}" colour="%{BKY_MATH_HUE}">
      <block type="math_number"></block>
    <block type="graph_set_y" deletable="true" x="100" y="100">
      <value name="VALUE">
      </value>
    </block>
      <block type="math_arithmetic">
        <value name="A">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
        <value name="B">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
      </block>
      <block type="math_single">
        <value name="NUM">
          <shadow type="math_number">
            <field name="NUM">9</field>
          </shadow>
        </value>
      </block>
      <block type="math_trig">
        <value name="NUM">
          <shadow type="math_number">
            <field name="NUM">45</field>
          </shadow>
        </value>
      </block>
      <block type="math_constant"></block>
      <block type="math_number_property">
        <value name="NUMBER_TO_CHECK">
          <shadow type="math_number">
            <field name="NUM">0</field>
          </shadow>
        </value>
      </block>
      <block type="math_round">
        <value name="NUM">
          <shadow type="math_number">
            <field name="NUM">3.1</field>
          </shadow>
        </value>
      </block>
      <block type="math_on_list"></block>
      <block type="math_modulo">
        <value name="DIVIDEND">
          <shadow type="math_number">
            <field name="NUM">64</field>
          </shadow>
        </value>
        <value name="DIVISOR">
          <shadow type="math_number">
            <field name="NUM">10</field>
          </shadow>
        </value>
      </block>
      <block type="math_constrain">
        <value name="VALUE">
          <shadow type="math_number">
            <field name="NUM">50</field>
          </shadow>
        </value>
        <value name="LOW">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
        <value name="HIGH">
          <shadow type="math_number">
            <field name="NUM">100</field>
          </shadow>
        </value>
      </block>
      <block type="math_random_int">
        <value name="FROM">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
        <value name="TO">
          <shadow type="math_number">
            <field name="NUM">100</field>
          </shadow>
        </value>
      </block>
      <block type="math_random_float"></block>
    </category>
    <category name="%{BKY_CATTEXT}" colour="%{BKY_TEXTS_HUE}">
      <block type="raw_text"></block>
      <block type="text"></block>
      <block type="text_join"></block>
      <block type="text_append">
        <value name="TEXT">
          <shadow type="text"></shadow>
        </value>
      </block>
      <block type="text_length">
        <value name="VALUE">
          <shadow type="text">
            <field name="TEXT">abc</field>
          </shadow>
        </value>
      </block>
      <block type="text_isEmpty">
        <value name="VALUE">
          <shadow type="text">
            <field name="TEXT"></field>
          </shadow>
        </value>
      </block>
      <block type="text_indexOf">
        <value name="VALUE">
          <block type="variables_get">
            <field name="VAR">{textVariable}</field>
          </block>
        </value>
        <value name="FIND">
          <shadow type="text">
            <field name="TEXT">abc</field>
          </shadow>
        </value>
      </block>
      <block type="text_charAt">
        <value name="VALUE">
          <block type="variables_get">
            <field name="VAR">{textVariable}</field>
          </block>
        </value>
      </block>
      <block type="text_getSubstring">
        <value name="STRING">
          <block type="variables_get">
            <field name="VAR">{textVariable}</field>
          </block>
        </value>
      </block>
      <block type="text_changeCase">
        <value name="TEXT">
          <shadow type="text">
            <field name="TEXT">abc</field>
          </shadow>
        </value>
      </block>
      <block type="text_trim">
        <value name="TEXT">
          <shadow type="text">
            <field name="TEXT">abc</field>
          </shadow>
        </value>
      </block>
      <block type="text_print">
        <value name="TEXT">
          <shadow type="text">
            <field name="TEXT">abc</field>
          </shadow>
        </value>
      </block>
      <block type="text_prompt_ext">
        <value name="TEXT">
          <shadow type="text">
            <field name="TEXT">abc</field>
          </shadow>
        </value>
      </block>
    </category>
    <category name="%{BKY_CATLISTS}" colour="%{BKY_LISTS_HUE}">
      <block type="lists_create_with">
        <mutation items="0"></mutation>
      </block>
      <block type="lists_create_with"></block>
      <block type="parameters_create_with"></block> 
      <block type="lists_repeat">
        <value name="NUM">
          <shadow type="math_number">
            <field name="NUM">5</field>
          </shadow>
        </value>
      </block>
      <block type="lists_length"></block>
      <block type="lists_isEmpty"></block>
      <block type="lists_indexOf">
        <value name="VALUE">
          <block type="variables_get">
            <field name="VAR">{listVariable}</field>
          </block>
        </value>
      </block>
      <block type="lists_getIndex">
        <value name="VALUE">
          <block type="variables_get">
            <field name="VAR">{listVariable}</field>
          </block>
        </value>
      </block>
      <block type="lists_setIndex">
        <value name="LIST">
          <block type="variables_get">
            <field name="VAR">{listVariable}</field>
          </block>
        </value>
      </block>
      <block type="lists_getSublist">
        <value name="LIST">
          <block type="variables_get">
            <field name="VAR">{listVariable}</field>
          </block>
        </value>
      </block>
      <block type="lists_split">
        <value name="DELIM">
          <shadow type="text">
            <field name="TEXT">,</field>
          </shadow>
        </value>
      </block>
      <block type="lists_sort"></block>
    </category>
    <category name="%{BKY_CATCOLOUR}" colour="%{BKY_COLOUR_HUE}">
      <block type="colour_picker"></block>
      <block type="colour_random"></block>
      <block type="colour_rgb">
        <value name="RED">
          <shadow type="math_number">
            <field name="NUM">100</field>
          </shadow>
        </value>
        <value name="GREEN">
          <shadow type="math_number">
            <field name="NUM">50</field>
          </shadow>
        </value>
        <value name="BLUE">
          <shadow type="math_number">
            <field name="NUM">0</field>
          </shadow>
        </value>
      </block>
      <block type="colour_blend">
        <value name="COLOUR1">
          <shadow type="colour_picker">
            <field name="COLOUR">#ff0000</field>
          </shadow>
        </value>
        <value name="COLOUR2">
          <shadow type="colour_picker">
            <field name="COLOUR">#3333ff</field>
          </shadow>
        </value>
        <value name="RATIO">
          <shadow type="math_number">
            <field name="NUM">0.5</field>
          </shadow>
        </value>
      </block>
    </category>
    <sep></sep>
    <category name="%{BKY_CATVARIABLES}" colour="%{BKY_VARIABLES_HUE}" custom="VARIABLE"></category>
    <category name="%{BKY_CATFUNCTIONS}" colour="%{BKY_PROCEDURES_HUE}" custom="PROCEDURE"></category>
  </xml>

<script>
  var options = {
    zone: document.getElementById('zone_joystick'),
    color: 'black'
  };
  var joystick;
	var message_send='';
  var manager = nipplejs.create(options);
	var ws_message_sender_timer = window.setInterval(ws_message_sender,300);
	function ws_message_sender(){
		if (message_send != ''){
			ws.send(message_send);
			message_send = '';
		}
	}
  // loader
  document.getElementById("loader").style.display = "none";
  
  manager.on('added', function (evt, nipple) {
      nipple.on('start move end dir plain', function (evt) {
          // DO EVERYTHING
        //console.log(evt);
      });
      nipple.on('dir:up', function (evt) {
        joystick = "KEY_UP_PRESS\n";
      });
      nipple.on('dir:down', function (evt) {
        joystick = "KEY_DOWN_PRESS\n";
      });
      nipple.on('dir:left', function (evt) {
        joystick = "KEY_LEFT_PRESS\n";
      });
      nipple.on('dir:right', function (evt) {
        joystick = "KEY_RIGHT_PRESS\n";
      });
      nipple.on('move', function (evt,data) {
        //console.log(data.distance);
        if (data.distance > 10){
          //ws.send(joystick);
          message_send = joystick;
        }else{
					message_send = '';
          ws.send("\n");
        }
      });
      nipple.on('end', function (evt,data) {
				message_send = '';
				ws.send("\n");
			});
  }).on('removed', function (evt, nipple) {
      nipple.off('start move end dir plain');
  });
  var lastkey='';
	var newkey='';
  $(document).keydown(function (e) {
      if ($(".input:focus") && (e.keyCode === 13)) {
        onSubmit();
      }
      if ($(".input:focus") && (e.keyCode === 37)) {
	      newkey = "KEY_LEFT_PRESS\n";
        if (lastkey != newkey) {
	        ws.send(newkey);
          lastkey = newkey;
        }
      }
      if ($(".input:focus") && (e.keyCode === 38)) {
	      if (lastkey != newkey) {
  	      newkey = "KEY_UP_PRESS\n";
  	      ws.send(newkey);
          lastkey = newkey;
	      }
      }
      if ($(".input:focus") && (e.keyCode === 39)) {
	      if (lastkey != newkey) {
  	      newkey = "KEY_RIGHT_PRESS\n";
  	      ws.send(newkey);
          lastkey = newkey;
	      }
      }
      if ($(".input:focus") && (e.keyCode === 40)) {
	      if (lastkey != newkey) {
  	      newkey = "KEY_DOWN_PRESS\n";
  	      ws.send(newkey);
          lastkey = newkey;
	      }
      }
   });
   $(document).keyup(function (e) {
     if ($(".input:focus") && (e.keyCode === 37)) {
      newkey = "KEY_LEFT_UP\n";
      ws.send(newkey);
      lastkey = 0;
     }
     if ($(".input:focus") && (e.keyCode === 38)) {
      newkey = "KEY_UP_UP\n";
      ws.send(newkey);
      lastkey = 0;
     }
     if ($(".input:focus") && (e.keyCode === 39)) {
      newkey = "KEY_RIGHT_UP\n";
      ws.send(newkey);
      lastkey = 0;
     }
     if ($(".input:focus") && (e.keyCode === 40)) {
      newkey = "KEY_DOWN_UP\n";
      ws.send(newkey);
      lastkey = 0;
     }
   });

    var ws;
    var wsStatus;
    var wsErrorStatus;

    if(ws == undefined) setInterval(init, 1000);

    function init() {
		if (ws != undefined) return;
      // Connect to Web Socket
      ws = new WebSocket("ws://"+window.location.hostname+":8008");
      //console.log(ws);
      // Set event handlers.
      ws.onopen = function() {
				output_clear();
        output("onOpen\n");
        wsStatus = "open";
      };

      ws.onmessage = function(e) {
        // e.data contains received string.
        output("onMessage: " + e.data);
      };

      ws.onclose = function() {
        if(wsStatus != "close") output("onClose\n");
        ws = undefined;
        wsStatus = "close";
      };

      ws.onerror = function(e) {
        if(wsErrorStatus != e.code) {
          //output("onerror\n");
          output("error: " + e.code +"\n");
          console.log(e)
        }
        ws = undefined;
        wsErrorStatus = e.code;
      };

    }

    function onSubmit() {
      var input = document.getElementById("input");
      // You can send message to the Web Socket using ws.send.
      newline = input.value + "\n";
      ws.send(newline);
      output("send: " + newline);
      input.value = "";
      input.focus();
    }

    function onCloseClick() {
      ws.close();
	    ws = undefined;
    }

    function output(str) {
      var log = document.getElementById("log");
      var escaped = str.replace(/&/, "&amp;").replace(/</, "&lt;").replace(/>/, "&gt;").replace(/"/, "&quot;"); // "
			if(log.innerHTML.length > 50000){
				log.innerHTML = "";
			}
			//console.log(log.innerHTML.length);
       log.innerHTML = log.innerHTML + "" + escaped;
       log.scrollTop = log.scrollHeight
    }
		function output_clear() {
			var log = document.getElementById("log");
			log.innerHTML = "";
		}
</script>
</body>
</html>
